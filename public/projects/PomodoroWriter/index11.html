<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pomodoro Writer</title>

  <!-- SEO & Open Graph Metadata -->
  <meta name="description" content="A Writer with Pomodoro, Tasks, Analytics & Mermaid Diagrams" />
  <meta property="og:title" content="Writer with Pomodoro, Tasks & Mermaid Support" />
  <meta property="og:description"
        content="A simple distraction-free writer with Pomodoro timer, tasks, text-quality assessment, and Mermaid diagram support" />
  <meta property="og:image" content="https://www.ankitdeshmukh.com/assets/mermaid-preview.png" />
  <meta property="og:url" content="https://www.ankitdeshmukh.com/" />
  <meta property="og:type" content="website" />
  <link rel="icon" href="https://ankitdeshmukh.com/projects/PomodoroWriter/favicon.ico"/>
  <link rel="icon" type="image/png" sizes="16x16" href="https://ankitdeshmukh.com/projects/PomodoroWriter/favicon.png" />
  <link rel="apple-touch-icon" href="https://www.ankitdeshmukh.com/apple-touch-icon.png" />

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-R5FJKDQD1M"></script>
  <script>
    var doNotTrack = false;
    if (!doNotTrack) {
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'G-R5FJKDQD1M', { 'anonymize_ip': false });
    }
  </script>

  <meta name="author" content="Dr. Ankit Deshmukh" />
  <link rel="canonical" href="https://www.ankitdeshmukh.com/projects/PomodoroWriter/" />
  <meta name="google-site-verification" content="G-R5FJKDQD1M" />

  <!-- CodeMirror 5 CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/monokai.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/gruvbox-dark.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/display/fullscreen.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous" />

  <!-- Mermaid CSS (Mermaid will inject its own styling) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.css" />

  <!-- html2canvas (for PNG export) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Custom Fonts & Root Colors -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

    :root {
      --bg-color: #1a1a1a;
      --container-bg: #2d2d2d;
      --text-color: #d5c4a1;
      --accent-color: #8ec07c;
      --acc-color: #ebdbb2;
      --border-color: #5a5a5a;
      --code-background: #3d3c3b;
      --task-complete: #689d6a;
      --header1-color: #d79921;
      --header2-color: #458588;
      --header3-color: #b16286;
      --link-color: #689d68;
      --selection-bg: #8ec07c;
      --selection-text: #1a1a1a;
      --save-indicator-color: #689d6a;
    }

    [data-theme="light"] {
      --bg-color: #f5f5f5;
      --container-bg: #ffffff;
      --text-color: #282828;
      --accent-color: #427b58;
      --acc-color: #3c3836;
      --border-color: #cccccc;
      --code-background: #f0e7d7;
      --task-complete: #98971a;
      --header1-color: #d79921;
      --header2-color: #458588;
      --header3-color: #b16286;
      --link-color: #689d68;
      --selection-bg: #b8bb26;
      --selection-text: #ffffff;
      --save-indicator-color: #427b58;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      letter-spacing: 0.02em;
      font-size: 62.5%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, background 0.6s ease-in-out;
      scroll-behavior: smooth;
      -ms-overflow-style: none;
      scrollbar-width: none;
      overflow: auto;
    }

    body[data-theme="dark"] {
      background: linear-gradient(135deg, #689d6a, #086279, #458588, #689d6a);
    }

    body[data-theme="light"] {
      background: linear-gradient(135deg, #b8bb26, #f1da53, #d79921, #b8bb26);
    }

    body::-webkit-scrollbar {
      display: none;
    }

    ::selection {
      background: var(--selection-bg) !important;
      color: var(--selection-text) !important;
      transition: background-color 0.2s ease;
    }

    h1, h2, h3 {
      margin: 1.5rem 0 0.75rem;
      line-height: 1.3;
      letter-spacing: 0.03em;
    }

    .writing-container {
      width: 100%;
      max-width: 720px;
      height: 92vh;
      background-color: var(--container-bg);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin: 2rem auto;
      transition: background-color 0.3s ease, box-shadow 0.4s ease, max-width 0.4s ease, height 0.4s ease;
    }

    .header {
      flex: 0 0 auto;
      background-color: var(--container-bg);
      padding: 1rem 2rem 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .stats {
      font-size: 1.3rem;
      color: var(--text-color);
    }

    /* LOCAL STORAGE INDICATOR STYLES */
    .save-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: 1rem;
      font-size: 1.2rem;
      color: var(--accent-color);
    }

    .save-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--save-indicator-color);
      transition: background-color 0.3s;
    }

    .save-indicator.saving {
      background-color: #fabd2f;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .controls {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .toggle-btn {
      position: relative;
      cursor: pointer;
      padding: 0.4rem 1rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 15px;
      font-size: 1.1rem;
      color: var(--accent-color);
      transition: border-color 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .toggle-btn:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--container-bg);
      color: var(--text-color);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 1rem;
      white-space: nowrap;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #themeToggle:hover::after { content: "Toggle Theme"; }
    #spellCheckToggle:hover::after { content: "Toggle Spellcheck (Ctrl+K)"; }
    #modeToggle:hover::after { content: "Toggle Preview (Ctrl+L)"; }
    #saveBtn:hover::after { content: "Save Markdown File (Ctrl+S)"; }
    #openBtn:hover::after { content: "Open Markdown File (Ctrl+O)"; }
    #zenToggle:hover::after { content: "Toggle Zen Mode (Ctrl+Z)"; }
    #toggleHeaderBtn:hover::after { content: "Hide/Show All"; }

    .content {
      flex: 1 1 auto;
      display: flex;
      overflow-y: auto;
    }

    .preview {
      display: none;
      width: 100%;
      max-width: 70ch;
      margin: 0 auto;
      font-family: 'Merriweather', Georgia, serif;
      font-size: 1.6rem;
      line-height: 1.8;
      color: var(--text-color);
      padding: 2rem 2rem 3rem;
      overflow: auto;
      hyphens: auto;
      text-rendering: optimizeLegibility;
    }

    .preview blockquote {
      border-left: 4px solid var(--accent-color);
      padding-left: 1.5rem;
      margin: 1.5rem 0;
      font-style: italic;
      color: var(--text-color);
      background: rgba(142, 192, 124, 0.05);
      border-radius: 4px;
    }

    .preview p code, .preview li code {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 1.4rem;
      background-color: var(--container-bg);
      color: var(--accent-color);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
    }

    /* Code block styling in preview */
    .preview pre {
      background-color: var(--code-background);
      color: var(--text-color);
      padding: 1rem;
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1.4rem;
      position: relative; /* for copy button */
      padding-top: 1.5rem;  /* make room for copy button */
      font-family: 'IBM Plex Mono', monospace;
    }

    .preview pre code {
      background: transparent;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 1.4rem;
    }

    /* Dark theme overrides: use the vs2015 highlight.js colors */
    body[data-theme="dark"] .preview pre code.hljs {
      /* vs2015 colors apply automatically, no override needed */
    }

    /* Light-theme overrides: force darker text and override hljs coloring */
    body[data-theme="light"] .preview pre {
      background-color: var(--code-background);
      border-color: var(--border-color);
    }

    body[data-theme="light"] .preview pre code.hljs {
      color: var(--text-color) !important;
    }
    body[data-theme="light"] .preview pre code.hljs .hljs-keyword,
    body[data-theme="light"] .preview pre code.hljs .hljs-title,
    body[data-theme="light"] .preview pre code.hljs .hljs-string,
    body[data-theme="light"] .preview pre code.hljs .hljs-comment,
    body[data-theme="light"] .preview pre code.hljs .hljs-number,
    body[data-theme="light"] .preview pre code.hljs .hljs-built_in,
    body[data-theme="light"] .preview pre code.hljs .hljs-attr,
    body[data-theme="light"] .preview pre code.hljs .hljs-literal,
    body[data-theme="light"] .preview pre code.hljs .hljs-section,
    body[data-theme="light"] .preview pre code.hljs .hljs-selector-tag {
      color: var(--text-color) !important;
    }

    .preview hr {
      border: none;
      border-top: 1px dashed var(--border-color);
      margin: 2rem 0;
    }

    .preview table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
      font-size: 1.4rem;
    }

    .preview th, .preview td {
      border: 1px solid var(--border-color);
      padding: 0.8rem;
      text-align: left;
    }

    .preview thead {
      background-color: var(--container-bg);
      color: var(--accent-color);
    }

    .preview sup {
      font-size: 1rem;
      vertical-align: super;
      color: var(--accent-color);
    }

    .preview sup a {
      text-decoration: none;
      color: var(--link-color);
    }

    .CodeMirror {
      height: 100%;
      font-family: "Roboto", sans-serif;
      font-size: 1.6rem;
      line-height: 1.8;
      color: var(--text-color);
      background-color: var(--container-bg);
      transition: font-size 0.4s ease, padding 0.4s ease;
    }

    .CodeMirror-scroll {
      padding: 1rem 2rem 2rem;
      overflow-y: scroll !important;
    }

    .CodeMirror-scrollbar-filler, .CodeMirror-gutter-filler, .CodeMirror-vscrollbar {
      width: 0 !important;
      display: none !important;
    }

    .CodeMirror-focused .CodeMirror-selected {
      background: rgba(255, 255, 255, 0.1);
    }

    .CodeMirror .cm-header-1 {
      color: #d79921 !important;
      font-size: 1.4em;
      line-height: 1.2;
    }

    .CodeMirror .cm-header-2 {
      color: #458588 !important;
      font-size: 1.2em;
    }

    .CodeMirror .cm-header-3 {
      color: #b16286 !important;
      font-size: 1.1em;
    }

    .CodeMirror .cm-quote {
      color: #928374 !important;
      font-style: italic;
    }

    .CodeMirror .cm-link {
      color: #689d6a !important;
      text-decoration: underline;
    }

    .CodeMirror .cm-url {
      color: #d65d0e !important;
    }

    .CodeMirror .cm-comment {
      color: #7c6f64 !important;
    }

    .CodeMirror .cm-em {
      color: #a89984 !important;
      font-style: italic;
    }

    .CodeMirror .cm-strong {
      color: #d5c4a1 !important;
      font-weight: bold;
    }

    .CodeMirror .cm-strikethrough {
      color: #bdae93 !important;
      text-decoration: line-through;
    }

    .CodeMirror .cm-variable-2 {
      color: #98971a !important;
    }

    .CodeMirror .cm-variable-3 {
      color: #d79921 !important;
    }

    .CodeMirror .cm-code {
      color: #8ec07c !important;
      background-color: #3c3836 !important;
      padding: 2px 4px;
      border-radius: 3px;
    }

    .CodeMirror .cm-comment.cm-code {
      color: #928374 !important;
    }

    .CodeMirror .cm-hr {
      color: #d3869b !important;
      font-weight: bold;
    }

    .CodeMirror .cm-tag.cm-image {
      color: #d3869b !important;
    }

    .CodeMirror .cm-string.cm-url.cm-image {
      color: #b8bb26 !important;
    }

    .CodeMirror .cm-table {
      color: #83a598 !important;
    }

    .CodeMirror .cm-table-header {
      color: #fe8019 !important;
      font-weight: bold;
    }

    .CodeMirror-empty {
      opacity: 0.4;
    }

    .CodeMirror-placeholder {
      opacity: 0.4 !important;
      display: inline !important;
    }

    .katex-display {
      margin: 1.2em 0;
      text-align: center;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .katex {
      white-space: nowrap;
    }

    .preview a, .footer a {
      color: var(--link-color);
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .preview a:hover, .footer a:hover {
      text-decoration: none;
      opacity: 0.85;
    }

    .preview p {
      margin: 0 0 1.5rem 0;
    }

    .preview ul, .preview ol {
      margin: 0 0 1.5rem 2rem;
      padding-left: 1rem;
    }

    .preview li {
      margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
      .preview {
        font-size: 1.4rem;
        padding: 1.5rem;
        max-width: 90%;
        line-height: 1.7;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .save-status {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }

    .preview img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1.5rem auto;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .preview img.medium {
      max-width: 75%;
    }

    .preview img.small {
      max-width: 50%;
    }

    .preview img.full-width {
      width: 100%;
      max-width: 100%;
    }

    .preview h1 {
      font-size: 2rem;
      margin: 0.2rem 0 0.4rem;
      color: var(--header1-color);
    }

    .preview h2 {
      font-size: 1.8rem;
      margin: 0.18rem 0 0.36rem;
      color: var(--header2-color);
    }

    .preview h3 {
      font-size: 1.6rem;
      margin: 0.15rem 0 0.3rem;
      color: var(--header3-color);
    }

    /* Copy‐button styles for code blocks */
    .copy-btn {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      padding: 0.2rem 0.5rem;
      font-size: 1rem;
      background: var(--container-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-color);
      opacity: 0.7;
      transition: opacity 0.2s ease, background 0.2s ease;
      z-index: 10;
    }
    .copy-btn:hover {
      opacity: 1;
      background: var(--accent-color);
      color: var(--container-bg);
    }

    /* Hide scrollbars in content & preview */
    .content::-webkit-scrollbar, .preview::-webkit-scrollbar {
      display: none;
    }

    /* Footer */
    .footer {
      font-size: 1.2rem;
      margin-top: 1rem;
      padding-bottom: 0.5rem;
      text-align: center;
    }

    /* --- Pomodoro Timer --- */
    #pomodoro-timer {
      position: fixed;
      top: 2rem;
      right: 2rem;
      min-width: 20rem;
      background-color: var(--container-bg);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transition: all 0.3s ease;
    }

    #pomodoro-timer:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    #minimizeBtn {
      position: absolute;
      top: 7px;
      right: 10px;
      background-color: transparent;
      color: var(--border-color);
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.2s ease;
    }

    #minimizeBtn:hover {
      transform: rotate(90deg);
    }

    #pomodoro-timer.minimized {
      width: 36px;
      min-width: 36px;
      height: 36px;
      border-radius: 8px;
      padding: 0 !important;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #pomodoro-timer.minimized .timer-display,
    #pomodoro-timer.minimized .timer-controls,
    #pomodoro-timer.minimized #audio-controls,
    #pomodoro-timer.minimized .task-controls,
    #pomodoro-timer.minimized #pomodoro-count {
      display: none;
    }

    /* --- Assessment Panel --- */
    #assess-timer {
      position: fixed;
      top: 2rem;
      left: 2rem;
      background-color: var(--container-bg);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      min-width: 20rem;
      transition: all 0.3s ease;
    }

    #assess-timer:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    #assess-timer.minimized {
      width: 36px;
      min-width: 36px;
      height: 36px;
      border-radius: 8px;
      padding: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #assess-timer.minimized #assessment-panel1,
    #assess-timer.minimized .assessment-metric {
      display: none;
    }

    .timer-display {
      font-size: 2.4rem;
      font-weight: bold;
      color: var(--header1-color);
      margin-bottom: 1rem;
      text-align: center;
      font-family: Roboto, Verdana, sans-serif;
    }

    .timer-controls {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .timer-button {
      padding: 0.4rem 1rem;
      border-radius: 15px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .timer-button:hover {
      background-color: var(--code-background);
    }

    #audio-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    #audio-select {
      padding: 0.3rem 0.6rem;
      border-radius: 8px;
      background-color: var(--container-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-size: 1rem;
    }

    #pomodoro-count {
      margin-top: 1rem;
      font-size: 1.4rem;
      color: #b8bb26;
      text-align: center;
    }

    .task-controls {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .task-input {
      display: flex;
      gap: 0.4rem;
    }

    .task-input input {
      flex: 1;
      padding: 0.4rem 0.6rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--container-bg);
      color: var(--text-color);
      font-size: 1rem;
    }

    .task-list {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 1.2rem;
    }

    .task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
      transition: background-color 0.2s ease;
    }

    .task-item:hover {
      background-color: var(--code-background);
    }

    .task-item.completed span {
      text-decoration: line-through;
      color: var(--task-complete);
    }

    .task-actions button {
      margin-left: 0.4rem;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--accent-color);
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .task-actions button:hover {
      background-color: var(--code-background);
    }

    #assessment-panel1 {
      font-family: Roboto, sans-serif;
      font-size: 1.2rem;
      color: var(--text-color);
    }

    #assessmentMinimizeBtn1 {
      position: absolute;
      top: 7px;
      left: 10px;
      background-color: transparent;
      color: var(--border-color);
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.2s ease;
    }

    #assessmentMinimizeBtn1:hover {
      transform: rotate(90deg);
    }

    #assessment-panel1.minimized {
      width: 36px;
      min-width: 36px;
      height: 36px;
      border-radius: 8px;
      padding: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .assessment-content {
      margin-top: 1.5rem;
    }

    .assessment-metric {
      margin-bottom: 0.8rem;
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .assessment-metric label {
      font-weight: 500;
      cursor: help;
    }

    .assessment-metric span {
      font-weight: 700;
    }

    /* Zen Mode */
    body.zen-mode .header,
    body.zen-mode .footer,
    body.zen-mode #pomodoro-timer,
    body.zen-mode #assess-timer {
      display: none !important;
    }

    body.zen-mode .writing-container {
      max-width: 56vw;
      height: 94vh;
      box-shadow: none;
      border-radius: 1.4rem;
    }

    body.zen-mode .CodeMirror {
      font-size: 1.8rem;
      padding: 1rem 1rem;
    }

    body.zen-mode .preview {
      font-size: 1.8rem;
      padding: 3rem 4rem;
    }

    body.zen-mode {
      background-color: var(--bg-color);
      overflow: hidden;
    }

    body.zen-mode .writing-container,
    body.zen-mode .content,
    body.zen-mode .CodeMirror-scroll,
    body.zen-mode .CodeMirror,
    body.zen-mode .CodeMirror-scrollbar-filler,
    body.zen-mode .CodeMirror-gutter-filler,
    body.zen-mode .CodeMirror-vscrollbar {
      overflow: hidden !important;
    }

    body.zen-mode .CodeMirror-scroll {
      overflow-y: auto !important;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    body.zen-mode .CodeMirror-scroll::-webkit-scrollbar {
      display: none !important;
    }

    /* Save button animation */
    .save-success {
      animation: scale 0.3s ease-in-out;
    }

    .glow-confirm {
      animation: glow 0.8s ease-in-out;
    }

    @keyframes scale {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 0px var(--accent-color); }
      50% { box-shadow: 0 0 14px var(--accent-color); }
      100% { box-shadow: 0 0 0px var(--accent-color); }
    }

    /* Add tooltip for save-indicator */
    .save-indicator {
      position: relative;
      display: inline-block;
      cursor: default;
    }

    .save-indicator[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--container-bg);
      color: var(--text-color);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 1rem;
      white-space: nowrap;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
  </style>

  <!-- Highlight.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css" />
</head>

<body data-theme="dark">
  <div class="writing-container">
    <div class="header">
      <div style="display: flex; align-items: center; flex-wrap: wrap;">
        <div class="stats" style="font-size: 1.3rem;">
          <span id="statsDisplay">Words: 0 · Readability: —</span>
        </div>
        <div class="save-status">
          <span class="save-indicator" id="saveIndicator" data-tooltip="Saved locally"></span>
        </div>
      </div>
      <div class="controls">
        <!-- ARROW TO HIDE/SHOW ALL HEADER BUTTONS -->
        <button type="button"
                style="color: var(--text-color); font-size: 1.6rem; border: none;"
                class="toggle-btn"
                id="toggleHeaderBtn"
                data-tooltip="Hide/Show All">❱</button>

        <!-- ALL OTHER HEADER BUTTONS (TO BE TOGGLED) -->
        <button type="button" style="color: var(--acc-color);" class="toggle-btn" id="saveBtn"
                data-tooltip="Save Markdown File (Ctrl+S)">Save .md</button>
        <button type="button" style="color: var(--acc-color);" class="toggle-btn" id="openBtn"
                data-tooltip="Open Markdown File (Ctrl+O)">Open .md</button>
        <input type="file" accept=".md" id="fileInput" style="display:none" />
        <button type="button" class="toggle-btn" id="spellCheckToggle" data-tooltip="Toggle Spellcheck (Ctrl+K)">Spell On</button>
        <button type="button" class="toggle-btn" id="modeToggle" data-tooltip="Toggle Preview (Ctrl+L)">Preview</button>
        <button type="button" class="toggle-btn" id="zenToggle" data-tooltip="Toggle Zen Mode (Ctrl+Z)">Zen</button>
        <button type="button" class="toggle-btn" id="themeToggle" data-tooltip="Toggle Theme">Light Mode</button>
      </div>
    </div>
    <div class="content">
      <!-- Use a <textarea> so CodeMirror can attach itself -->
      <textarea id="editor"></textarea>
      <div class="preview" id="preview"></div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    © 2025 Ankit Deshmukh •
    <a style="color: var(--text-color);" href="https://www.ankitdeshmukh.com" target="_blank" rel="noopener">ankitdeshmukh.com</a> •
    <a style="color: var(--text-color);" href="https://www.ankitdeshmukh.com/avocation/pomodorowriter/" target="_blank" rel="noopener">Documentation</a>
  </div>

  <!-- Pomodoro Timer with Task Management -->
  <div id="pomodoro-timer">
    <button type="button" id="minimizeBtn" aria-label="Minimize Pomodoro Timer" title="Minimize Timer (Ctrl+M)">✕</button>
    <div class="timer-display" id="timer">
      <span id="minutes">25</span>:<span id="seconds">00</span>
    </div>
    <div class="timer-controls">
      <button type="button" id="toggle-timer" class="timer-button">Start</button>
      <button type="button" id="reset" class="timer-button">Reset</button>
      <!-- Audio Controls -->
      <div id="audio-controls">
        <button type="button" id="toggle-music" class="timer-button">Play Music</button>
        <select id="audio-select">
          <option value="background.opus">Cosmic</option>
          <option value="background2.opus">Muse</option>
          <option value="background3.opus">Burble</option>
          <option value="background4.opus">Focus</option>
        </select>
      </div>
      <!-- Task Management -->
      <div class="task-controls">
        <div class="task-input">
          <input type="text" id="taskInput" placeholder="Add new task..." style="width: 10rem;" />
          <button type="button" class="timer-button" id="addTask">Add</button>
        </div>
        <ul id="taskList" class="task-list"></ul>
      </div>
      <!-- Pomodoro Count -->
      <div id="pomodoro-count">Pomodoros: 0</div>
    </div>
  </div>

  <!-- Assessment Timer & Metrics -->
  <div id="assess-timer">
      <button type="button" id="assessmentMinimizeBtn1" title="Minimize Assessment (Ctrl+M)">✕</button>
    <div id="assessment-panel1">
      <div class="assessment-content">
        <div class="assessment-metric" title="US school grade level. Lower is easier to read."
             style="padding-top: 10px;">
          <label>Flesch–Kincaid Grade:</label> <span id="fkGrade">—</span>
        </div>
        <div class="assessment-metric" title="Score between 0–100. Higher is easier to read.">
          <label>Reading Ease:</label> <span id="readingEase">—</span>
        </div>
        <div class="assessment-metric"
             title="Number of years of formal education needed to easily understand a piece of writing.">
          <label>Gunning Fog Index:</label> <span id="gunningFog">—</span>
        </div>
        <div class="assessment-metric" title="Grade level based on letters and sentences.">
          <label>Coleman–Liau Index:</label> <span id="colemanLiau">—</span>
        </div>
        <div class="assessment-metric" title="Average characters per word.">
          <label>Avg. Word Length:</label> <span id="avgWordLength">—</span>
        </div>
        <div class="assessment-metric" title="Average words per sentence.">
          <label>Avg. Sentence Length:</label> <span id="avgSentenceLength">—</span>
        </div>
        <div class="assessment-metric" title="Count of Academic Word List (AWL) matches.">
          <label>AWL Matches:</label> <span id="awlCount">—</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Audio Elements -->
  <audio id="audio-unlocker" style="display: none;"></audio>
  <audio id="background-audio" src="background.opus" loop></audio>

  <!-- CodeMirror 5 and Dependencies -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/display/placeholder.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/markdown/markdown.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/display/fullscreen.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

  <!-- ========================
       MERMAID.JS (Diagramming)
       ======================== -->
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <!-- Highlight.js Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>
    hljs.configure({ languages: ["r", "python", "javascript", "bash", "xml", "markdown"] });
  </script>

  <!-- Main Application Script -->
  <script>
    /******************************************************************
     * INITIAL STATE & MERMAID INITIALIZATION
     ******************************************************************/
    let isDarkTheme = true;

    window.addEventListener('load', () => {
      mermaid.initialize({
        startOnLoad: true,
        theme: 'neutral',
        securityLevel: 'loose',
        logLevel: 'warn',
        themeVariables: { fontFamily: 'Roboto, sans-serif' }
      });
    });

    /******************************************************************
     * ELEMENT REFERENCES & STATE FLAGS
     ******************************************************************/
    const preview = document.getElementById('preview');
    const statsDisplay = document.getElementById('statsDisplay');
    const themeToggle = document.getElementById('themeToggle');
    const spellToggle = document.getElementById('spellCheckToggle');
    const modeToggle = document.getElementById('modeToggle');
    const openBtn = document.getElementById('openBtn');
    const saveBtn = document.getElementById('saveBtn');
    const fileInput = document.getElementById('fileInput');
    const zenToggle = document.getElementById('zenToggle');
    const saveIndicator = document.getElementById('saveIndicator');

    let codemirror;
    let isPreview = false;
    let spellCheckEnabled = false;
    let hasUnsavedChanges = false;
    let audioUnlocked = false;

    // Pomodoro elements
    const minutesElement = document.getElementById('minutes');
    const secondsElement = document.getElementById('seconds');
    const toggleTimerButton = document.getElementById('toggle-timer');
    const resetButton = document.getElementById('reset');
    const pomodoroCountElement = document.getElementById('pomodoro-count');
    const audioSelect = document.getElementById('audio-select');
    let minutes = 25, seconds = 0;
    let timerInterval, isTimerRunning = false, pomodoroCount = 0;

    const taskInput = document.getElementById('taskInput');
    const addTaskButton = document.getElementById('addTask');
    const taskList = document.getElementById('taskList');
    let tasks = [];

    const minimizeBtn = document.getElementById('minimizeBtn');
    const assessmentMinimizeBtn1 = document.getElementById('assessmentMinimizeBtn1');

    const fkGradeSpan = document.getElementById('fkGrade');
    const readingEaseSpan = document.getElementById('readingEase');
    const gunningFogSpan = document.getElementById('gunningFog');
    const colemanLiauSpan = document.getElementById('colemanLiau');
    const avgWordLengthSpan = document.getElementById('avgWordLength');
    const avgSentenceLengthSpan = document.getElementById('avgSentenceLength');
    const awlCountSpan = document.getElementById('awlCount');

    /******************************************************************
     * 2. INIT CODEMIRROR (v5) WITH CONTENTEDITABLE INPUT
     ******************************************************************/
    document.addEventListener('DOMContentLoaded', () => {
      codemirror = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: 'markdown',
        lineNumbers: false,
        theme: 'gruvbox',
        autofocus: true,
        lineWrapping: true,
        inputStyle: 'contenteditable',
        placeholder: "Start Writing …",
        extraKeys: {
          'F11': (cm) => cm.setOption('fullScreen', !cm.getOption('fullScreen')),
          'Esc': (cm) => { if (cm.getOption('fullScreen')) cm.setOption('fullScreen', false); }
        }
      });
      codemirror.setOption('cursorBlinkRate', 0);
      codemirror.getInputField().setAttribute('spellcheck', spellCheckEnabled);
      initializeApp();
    });

    /******************************************************************
     * 3. INITIALIZE APPLICATION
     ******************************************************************/
    function initializeApp() {
      // LOCAL STORAGE: Load saved editor content
      const savedContent = localStorage.getItem('editorContent');
      if (savedContent) {
        codemirror.setValue(savedContent);
      }

      // MARKED + Mermaid extension
      const mermaidExtension = {
        name: 'mermaid',
        level: 'block',
        start(src) { return src.match(/^```mermaid\s*\n/)?.index; },
        tokenizer(src) {
          const rule = /^```mermaid\s*\n([\s\S]+?)```/;
          const match = rule.exec(src);
          if (match) {
            return { type: 'mermaid', raw: match[0], text: match[1].trim() };
          }
        },
        renderer(token) {
          return `<div class="mermaid" style="display: flex; justify-content: center;">${token.text}</div>\n`;
        }
      };

      marked.use({ extensions: [mermaidExtension] });
      marked.setOptions({
        breaks: true,
        gfm: true,
        mangle: false,
        headerIds: false,
        highlight: (code, lang) => {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return hljs.highlightAuto(code).value;
        }
      });

      setupEventListeners();
      loadTasks();
      updateStats();
      updateAssessment();
      updateTimerDisplay();
      updatePomodoroCount();

      if (!window.showSaveFilePicker) saveBtn.style.display = 'none';
      if (!window.File || !window.FileReader) openBtn.style.display = 'none';
      showStatus('Saved locally');
    }

    /******************************************************************
     * 4. EVENT LISTENERS SETUP
     ******************************************************************/
    function setupEventListeners() {
      codemirror.on('change', () => {
        updateStats();
        updateAssessment();
        if (isPreview) processPreview();
        hasUnsavedChanges = true;

        // Auto‐save to localStorage (debounced)
        clearTimeout(autoSaveTimeout);
        showStatus('Saving...');
        autoSaveTimeout = setTimeout(() => {
          saveToLocalStorage();
          showStatus('Saved locally');
        }, 1000);
      });

      // Typing sound
      const keySound = new Audio('https://assets.codepen.io/3/typewriter-key.mp3');
      keySound.volume = 0.08;
      codemirror.on('keypress', () => {
        keySound.currentTime = 0;
        keySound.play().catch(() => {});
      });

      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'l') {
          e.preventDefault();
          toggleMode();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
          e.preventDefault();
          document.getElementById('pomodoro-timer').classList.toggle('minimized');
          document.getElementById('assess-timer').classList.toggle('minimized');
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          saveBtn.click();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o') {
          e.preventDefault();
          fileInput.click();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          toggleSpellcheck();
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'x') {
          e.preventDefault();
          document.body.classList.toggle('zen-mode');
          zenToggle.textContent = document.body.classList.contains('zen-mode') ? 'Exit Zen' : 'Zen';
          if (document.body.classList.contains('zen-mode')) {
            backgroundAudio.pause();
            document.getElementById('toggle-music').textContent = 'Play Music';
          }
        }
        if (e.key === 'Escape' && document.body.classList.contains('zen-mode')) {
          e.preventDefault();
          document.body.classList.remove('zen-mode');
          zenToggle.textContent = 'Zen';
        }
      });

      modeToggle.addEventListener('click', toggleMode);
      themeToggle.addEventListener('click', toggleTheme);
      spellToggle.addEventListener('click', toggleSpellcheck);
      openBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileOpen);
      saveBtn.addEventListener('click', handleSave);
      zenToggle.addEventListener('click', () => {
        document.body.classList.toggle('zen-mode');
        zenToggle.textContent = document.body.classList.contains('zen-mode') ? 'Exit Zen' : 'Zen';
        if (document.body.classList.contains('zen-mode')) {
          backgroundAudio.pause();
          document.getElementById('toggle-music').textContent = 'Play Music';
        }
      });

      window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '';
        }
      });

      toggleTimerButton.addEventListener('click', toggleTimer);
      resetButton.addEventListener('click', resetTimer);
      audioSelect.addEventListener('change', changeAudio);
      document.getElementById('toggle-music').addEventListener('click', toggleMusic);

      addTaskButton.addEventListener('click', () => addTask(taskInput.value));
      taskInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addTask(taskInput.value);
      });

      minimizeBtn.addEventListener('click', () => {
        document.getElementById('pomodoro-timer').classList.toggle('minimized');
      });
      assessmentMinimizeBtn1.addEventListener('click', () => {
        document.getElementById('assess-timer').classList.toggle('minimized');
      });

      // Toggle header buttons:
      const toggleHeaderBtn = document.getElementById('toggleHeaderBtn');
      toggleHeaderBtn.addEventListener('click', () => {
        const headerButtons = document.querySelectorAll('.controls .toggle-btn:not(#toggleHeaderBtn)');
        headerButtons.forEach(btn => {
          btn.style.display = (btn.style.display !== 'none' ? 'none' : 'inline-flex');
        });
        const firstVisible = document.querySelector('.controls .toggle-btn:not(#toggleHeaderBtn)').style.display !== 'none';
        toggleHeaderBtn.textContent = firstVisible ? '❱' : '☰';
        toggleHeaderBtn.setAttribute('data-tooltip', firstVisible ? 'Hide All' : 'Show All');
      });
    }

    let autoSaveTimeout;

    /******************************************************************
     * LOCAL STORAGE FUNCTIONS
     ******************************************************************/
    function saveToLocalStorage() {
      const content = codemirror.getValue();
      localStorage.setItem('editorContent', content);
    }

    function showStatus(message) {
      const indicator = document.getElementById('saveIndicator');
      indicator.setAttribute('data-tooltip', message);
      if (message === 'Saving...') indicator.classList.add('saving');
      else indicator.classList.remove('saving');
    }

    /******************************************************************
     * 5. SYLLABLE COUNT & READABILITY IMPLEMENTATIONS
     ******************************************************************/
    function countSyllables(word) {
      word = word.toLowerCase().trim();
      if (word.length <= 2) return 1;
      word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
      word = word.replace(/^y/, '');
      const matches = word.match(/[aeiouy]{1,2}/g) || [];
      return Math.max(1, matches.length);
    }

    function computeColemanLiau(text) {
      const cleanText = text.replace(/[^A-Za-z\s\.!?]/g, '');
      const sentences = cleanText.split(/[\.\!?]+/).filter(s => s.trim().length > 0).length || 1;
      const words = cleanText.split(/\s+/).filter(w => w.trim().length > 0).length || 1;
      const letters = cleanText.replace(/[^A-Za-z]/g, '').length;
      const L = (letters / words) * 100;
      const S = (sentences / words) * 100;
      return 0.0588 * L - 0.296 * S - 15.8;
    }

    function countComplexWords(text) {
      const cleanText = text.replace(/[^A-Za-z\s]/g, '');
      const wordsArray = cleanText.split(/\s+/).filter(w => w.length > 0);
      let count = 0;
      wordsArray.forEach(w => { if (countSyllables(w) >= 3) count++; });
      return count;
    }

    /******************************************************************
     * 6. UPDATE TEXT ASSESSMENT
     ******************************************************************/
    const AWL = [
      "analyze","approach","area","assess","assume","authority","available","benefit","concept","consistent",
      "constitute","context","contract","create","data","define","derive","distribute","economic","environment",
      "establish","estimate","evident","export","factor","finance","formula","function","identify","impact",
      "indicate","individual","interpret","involve","issue","labor","legal","legislate","major","method",
      "occur","percent","period","policy","principle","proceed","process","require","research","respond","role",
      "section","sector","significant","similar","source","structure","theory","vary","achieve","acquire",
      "administrate","affect","appropriate","aspect","assist","category","chapter","commission","community",
      "complex","compute","conclude","conduct","consequence","construct","consume","credit","culture","design",
      "distinct","element","equate","evaluate","feature","final","focus","impact","injure","institute",
      "invest","item","journal","maintain","normal","obtain","participate","perceive","positive","potential",
      "previous","primary","purchase","range","region","regulate","relevant","reside","resource","restrict",
      "secure","select","site","strategy","survey","text","tradition","transfer","alternative","circumstance",
      "comment","compensate","component","consent","considerable","constant","constrain","contribute","convene",
      "coordinate","core","corporate","correspond","criteria","deduce","demonstrate","document","dominate",
      "emphasis","ensure","exclude","framework","fund","illustrate","immigrate","imply","initial","instance",
      "interact","justify","layer","link","locate","maximize","minor","negate","outcome","partner","philosophy",
      "proportion","publish","react","register","rely","remove","scheme","sequence","sex","shift","specify",
      "sufficient","task","technical","technique","technology","valid","volume","access","adequate","annual",
      "apparent","approximate","attitude","attribute","civil","code","commit","communicate","concentrate",
      "conference","contrast","cycle","debate","despite","dimension","domestic","emerge","error","ethnic",
      "goal","grant","hence","hypothesis","implement","implicate","impose","integrate","internal","investigate",
      "job","label","mechanism","obvious","occupy","option","output","overall","parallel","parameter",
      "phase","predict","principal","prior","professional","project","promote","resolve","retain","series",
      "statistic","status","stress","substitute","sufficient","summary","undertake","academy","adjust",
      "alter","amend","aware","capacity","challenge","clause","compound","conflict","consult","contact",
      "decline","discrete","draft","enable","energy","enforce","entity","equivalent","evolve","expand",
      "expose","external","facilitate","fundamental","generate","generation","image","liberal","licence",
      "logic","marginal","medical","mental","modify","monitor","network","notion","objective","orient",
      "output","overall","perspective","precise","prime","psychology","pursue","ratio","reject","revenue",
      "stable","style","subsidy","substitute","symbol","target","transition","trend","version","welfare",
      "whereas","abstract","accurate","acknowledge","aggregate","allocate","assign","attach","author",
      "brief","capable","cite","cooperate","discriminate","display","diverse","domain","edit","enhance",
      "estate","exceed","expert","explicit","federal","fee","flexible","ignore","incentive","incorporate",
      "index","inhibit","initiate","input","instruction","intelligence","interval","lecture","migrate",
      "minimum","nuclear","overseas","precede","presume","rational","recover","reveal","revenue","scope",
      "subsidiary","tape","trace","transform","transport","underlie","utilize","adapt","adult","advocate",
      "aid","channel","classic","comprehensive","comprise","confirm","contrary","convert","decade","definite",
      "deny","differentiate","dispose","dynamic","eliminate","empirical","equip","extract","file","finite",
      "foundation","grade","guarantee","hierarchy","highlight","identify","ignore","incentive","incorporate",
      "index","inhibit","initiate","input","insert","intervene","isolate","manual","media","mode","paradigm",
      "phenomenon","priority","protocol","publication","refine","reform","regime","relax","restrain","revolution",
      "scenario","schedule","scheme","scope","simulate","sole","somewhat","submit","successor","survive","suspend",
      "team","tense","terminate","theme","thereby","topic","transmit","ultimate","unique","visible","volunteer"
    ];

    function updateAssessment() {
      const text = codemirror ? codemirror.getValue().trim() : '';
      if (!text) {
        fkGradeSpan.textContent = '—';
        readingEaseSpan.textContent = '—';
        gunningFogSpan.textContent = '—';
        colemanLiauSpan.textContent = '—';
        avgWordLengthSpan.textContent = '0';
        avgSentenceLengthSpan.textContent = '0';
        awlCountSpan.textContent = '0';
        return;
      }

      const sentenceArr = text.split(/[\.\!?]+/).filter(s => s.trim().length > 0);
      const wordsArr = text.split(/\s+/).filter(w => w.trim().length > 0);
      const numSentences = sentenceArr.length || 1;
      const numWords = wordsArr.length || 1;

      let totalSyllables = 0;
      let totalLetters = 0;
      wordsArr.forEach(w => {
        totalSyllables += countSyllables(w.replace(/[^A-Za-z]/g, ''));
        totalLetters += w.replace(/[^A-Za-z]/g, '').length;
      });

      const complexWords = countComplexWords(text);

      let awlMatches = 0;
      wordsArr.forEach(w => {
        if (AWL.includes(w.toLowerCase().replace(/[^A-Za-z]/g, ''))) {
          awlMatches++;
        }
      });

      const avgWordLength = totalLetters / numWords;
      const avgSentenceLength = numWords / numSentences;

      const fk = 0.39 * (numWords / numSentences) + 11.8 * (totalSyllables / numWords) - 15.59;
      const ease = 206.835 - 1.015 * (numWords / numSentences) - 84.6 * (totalSyllables / numWords);
      const fog = 0.4 * ((numWords / numSentences) + 100 * (complexWords / numWords));
      const cl = computeColemanLiau(text);

      fkGradeSpan.textContent = fk.toFixed(1);
      readingEaseSpan.textContent = ease.toFixed(1);
      gunningFogSpan.textContent = fog.toFixed(1);
      colemanLiauSpan.textContent = cl.toFixed(1);
      avgWordLengthSpan.textContent = avgWordLength.toFixed(2);
      avgSentenceLengthSpan.textContent = avgSentenceLength.toFixed(2);
      awlCountSpan.textContent = awlMatches;
    }

    /******************************************************************
     * 7. TOGGLE EDIT ↔ PREVIEW
     ******************************************************************/
    function toggleMode() {
      isPreview = !isPreview;
      if (isPreview) {
        codemirror.getWrapperElement().style.display = 'none';
        preview.style.display = 'block';
        processPreview();
        modeToggle.textContent = 'Edit';
      } else {
        // Remove any existing copy buttons from preview
        preview.querySelectorAll('.copy-btn').forEach(btn => btn.remove());
        // Remove any export buttons from preview
        preview.querySelectorAll('.export-btn').forEach(btn => btn.remove());
        preview.style.display = 'none';
        codemirror.getWrapperElement().style.display = 'block';
        modeToggle.textContent = 'Preview';
      }
      updateAssessment();
      updateStats();
    }

    /******************************************************************
     * 8. PROCESS PREVIEW (MARKDOWN → HTML → KaTeX → Mermaid ← SVG/PNG EXPORT)
     ******************************************************************/
    function processPreview() {
      // Only run if currently in preview mode
      if (!isPreview) return;

      const rawHtml = marked.parse(codemirror.getValue());
      preview.innerHTML = rawHtml;

      // Syntax highlighting for all code blocks
      preview.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
      });
      // Add “Copy” button to each <pre> inside preview
      preview.querySelectorAll('pre').forEach(preBlock => {
        if (!preBlock.querySelector('.copy-btn')) {
          const button = document.createElement('button');
          button.className = 'copy-btn';
          button.innerText = 'Copy';
          button.setAttribute('title', 'Copy code to clipboard');
          preBlock.insertBefore(button, preBlock.firstChild);
          button.addEventListener('click', () => {
            const codeNode = preBlock.querySelector('code');
            if (!codeNode) return;
            const textToCopy = codeNode.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
              button.innerText = 'Copied!';
              setTimeout(() => (button.innerText = 'Copy'), 1000);
            }, () => {
              button.innerText = 'Error';
              setTimeout(() => (button.innerText = 'Copy'), 1000);
            });
          });
        }
      });

      // KaTeX rendering
      setTimeout(() => {
        if (typeof renderMathInElement !== 'undefined' && window.renderMathInElement) {
          renderMathInElement(preview, {
            delimiters: [
              { left: '$$', right: '$$', display: true },
              { left: '$', right: '$', display: false },
              { left: '\\(', right: '\\)', display: false },
              { left: '\\[', right: '\\]', display: true }
            ],
            ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            ignoredClasses: ['cm-code'],
            throwOnError: false,
            strict: false
          });
        }
      }, 10);

      // Mermaid diagrams
      setTimeout(() => {
        mermaid.run({ querySelector: '.mermaid', suppressErrors: true }).catch(e => console.error('Mermaid error:', e));
      }, 100);

      setTimeout(attachExportButtons, 150);
    }

    /******************************************************************
     * 9. ATTACH EXPORT BUTTONS FOR MERMAID DIAGRAMS (SVG + PNG)
     ******************************************************************/
    function attachExportButtons() {
      const mermaidWrappers = preview.querySelectorAll('.mermaid');
      mermaidWrappers.forEach((wrapper, index) => {
        if (wrapper.querySelector('.export-btn')) return;

        const btnContainer = document.createElement('div');
        btnContainer.style.textAlign = 'center';
        btnContainer.style.margin = '0.5rem auto';

        // SVG Button
        const svgBtn = document.createElement('button');
        svgBtn.textContent = 'Export SVG';
        svgBtn.className = 'export-btn';
        svgBtn.style.cssText = baseButtonStyle();
        svgBtn.addEventListener('click', () => exportMermaidAsSVG(wrapper));

        // PNG Button
        const pngBtn = document.createElement('button');
        pngBtn.textContent = 'Export PNG';
        pngBtn.className = 'export-btn';
        pngBtn.style.cssText = baseButtonStyle();
        pngBtn.addEventListener('click', () => exportMermaidAsPNG(wrapper, index));

        btnContainer.appendChild(svgBtn);
        btnContainer.appendChild(pngBtn);
        wrapper.parentNode.insertBefore(btnContainer, wrapper.nextSibling);
      });
    }

    function baseButtonStyle() {
      return `
        display: inline-block;
        margin: 0.3rem 0.6rem;
        padding: 0.4rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: transparent;
        color: var(--accent-color);
        cursor: pointer;
        font-size: 1.2rem;
      `;
    }

    /******************************************************************
     * EXPORT MERMAID AS SVG
     ******************************************************************/
    function exportMermaidAsSVG(wrapper) {
      const svg = wrapper.querySelector('svg');
      if (!svg) {
        alert('No SVG found to export.');
        return;
      }
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svg);
      const blob = new Blob([svgString], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `diagram-${Date.now()}.svg`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    /******************************************************************
     * EXPORT MERMAID AS PNG (HIGH-QUALITY USING html2canvas)
     ******************************************************************/
    async function exportMermaidAsPNG(wrapper, index) {
      const svg = wrapper.querySelector('svg');
      if (!svg) return alert('No SVG found to export.');

      const factor = prompt("Enter export resolution (1–6 recommended)", "3");
      const scale = Math.max(1, Math.min(6, parseInt(factor))) || 3;

      const cloned = wrapper.cloneNode(true);
      cloned.style.margin = "0 auto";
      cloned.style.backgroundColor = "#ffffff";
      document.body.appendChild(cloned);

      const canvas = await html2canvas(cloned, {
        scale: scale,
        backgroundColor: "#ffffff",
        useCORS: true
      });

      const link = document.createElement('a');
      link.download = `diagram-${index + 1}@${scale}x.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      document.body.removeChild(cloned);
    }

    /******************************************************************
     * HELPER: ESCAPE HTML FOR CODE BLOCKS
     ******************************************************************/
    function escapeHtml(html) {
      return html
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /******************************************************************
     * 10. TOGGLE DARK ↔ LIGHT THEME (APP‐LEVEL, not Mermaid)
     ******************************************************************/
    function toggleTheme() {
      isDarkTheme = !isDarkTheme;
      document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
      codemirror.setOption('theme', isDarkTheme ? 'gruvbox' : 'default');
      themeToggle.textContent = isDarkTheme ? 'Light Mode' : 'Dark Mode';
    }

    /******************************************************************
     * 11. TOGGLE SPELLCHECK ON ↔ OFF
     ******************************************************************/
    function toggleSpellcheck() {
      spellCheckEnabled = !spellCheckEnabled;
      codemirror.getInputField().setAttribute('spellcheck', spellCheckEnabled);
      spellToggle.textContent = spellCheckEnabled ? 'Spell Off' : 'Spell On';
    }

    /******************************************************************
     * 12. HANDLE FILE OPEN (File System Access API)
     ******************************************************************/
    function handleFileOpen(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        codemirror.setValue(evt.target.result);
        updateStats();
        updateAssessment();
        if (isPreview) processPreview();
        saveToLocalStorage();
        showStatus('Saved locally');
      };
      reader.onerror = () => {
        alert('Failed to read the file. Please try again.');
      };
      reader.readAsText(file);
      fileInput.value = '';
    }

    /******************************************************************
     * 13. HANDLE FILE SAVE (File System Access API)
     ******************************************************************/
    async function handleSave() {
      if (!window.showSaveFilePicker) {
        alert('Save feature not supported in this browser.');
        return;
      }
      const text = codemirror.getValue();
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: 'document.md',
          types: [{ description: 'Markdown Files', accept: { 'text/markdown': ['.md'] } }],
        });
        const writable = await handle.createWritable();
        await writable.write(text);
        await writable.close();
        hasUnsavedChanges = false;

        // Pulse Save Button
        saveBtn.classList.add('save-success');
        setTimeout(() => saveBtn.classList.remove('save-success'), 1000);

        // Gentle container glow
        const container = document.querySelector('.writing-container');
        container.classList.add('glow-confirm');
        setTimeout(() => container.classList.remove('glow-confirm'), 1200);
      } catch (err) {
        if (err.name !== 'AbortError') console.error('Save failed:', err);
      }
    }

    /******************************************************************
     * 14. POMODORO TIMER FUNCTIONALITY
     ******************************************************************/
    const backgroundAudio = document.getElementById('background-audio');
    const toggleMusicButton = document.getElementById('toggle-music');

    function unlockAudio() {
      if (audioUnlocked) return;
      const unlockSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');
      unlockSound.play()
        .then(() => {
          unlockSound.pause();
          audioUnlocked = true;
          updateTimerDisplay();
        })
        .catch(() => {});
    }
    document.addEventListener('click', unlockAudio, { once: true });
    document.addEventListener('touchstart', unlockAudio, { once: true });

    function updateTimerDisplay() {
      minutesElement.textContent = String(minutes).padStart(2, '0');
      secondsElement.textContent = String(seconds).padStart(2, '0');
    }

    function updatePomodoroCount() {
      pomodoroCountElement.textContent = `Pomodoros: ${pomodoroCount}`;
    }

    function startTimer() {
      if (!audioUnlocked) {
        alert('Please interact with the page to unlock audio.');
        return;
      }
      backgroundAudio.play().catch(() => {});
      timerInterval = setInterval(() => {
        seconds--;
        if (seconds < 0) {
          seconds = 59;
          minutes--;
        }
        if (minutes < 0) {
          clearInterval(timerInterval);
          alert('Pomodoro complete!');
          pomodoroCount++;
          resetTimer();
          return;
        }
        updateTimerDisplay();
      }, 1000);
      isTimerRunning = true;
      toggleTimerButton.textContent = 'Pause';
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      backgroundAudio.pause();
      isTimerRunning = false;
      toggleTimerButton.textContent = 'Start';
    }

    function toggleTimer() {
      if (isTimerRunning) pauseTimer();
      else startTimer();
    }

    function resetTimer() {
      clearInterval(timerInterval);
      backgroundAudio.pause();
      backgroundAudio.currentTime = 0;
      minutes = 25;
      seconds = 0;
      updateTimerDisplay();
      isTimerRunning = false;
      toggleTimerButton.textContent = 'Start';
      updatePomodoroCount();
    }

    /******************************************************************
     * 15. AUDIO CONTROLS
     ******************************************************************/
    function toggleMusic() {
      if (!audioUnlocked) {
        alert('Please interact with the page to unlock audio.');
        return;
      }
      try {
        if (backgroundAudio.paused) {
          backgroundAudio.play();
          toggleMusicButton.textContent = 'Pause Music';
        } else {
          backgroundAudio.pause();
          toggleMusicButton.textContent = 'Play Music';
        }
      } catch (err) {
        alert('Audio playback failed: ' + err.message);
      }
    }

    function changeAudio() {
      if (!audioUnlocked) return;
      try {
        backgroundAudio.pause();
        backgroundAudio.currentTime = 0;
        backgroundAudio.src = audioSelect.value;
        backgroundAudio.play();
        toggleMusicButton.textContent = 'Pause Music';
      } catch (err) {
        alert('Failed to load audio track: ' + err.message);
      }
    }

    /******************************************************************
     * 16. TASK MANAGEMENT
     ******************************************************************/
    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function loadTasks() {
      const saved = localStorage.getItem('tasks');
      if (saved) {
        try {
          tasks = JSON.parse(saved);
          renderTasks();
        } catch {
          tasks = [];
        }
      }
    }

    function renderTasks() {
      taskList.innerHTML = '';
      tasks.forEach((task, idx) => {
        const li = document.createElement('li');
        li.className = 'task-item' + (task.completed ? ' completed' : '');
        const span = document.createElement('span');
        span.textContent = task.text;
        const actions = document.createElement('div');
        actions.className = 'task-actions';

        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = task.completed ? '↺' : '✔';
        toggleBtn.title = task.completed ? 'Mark Incomplete' : 'Mark Complete';
        toggleBtn.addEventListener('click', () => {
          tasks[idx].completed = !tasks[idx].completed;
          saveTasks();
          renderTasks();
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '✕';
        deleteBtn.title = 'Delete Task';
        deleteBtn.addEventListener('click', () => {
          tasks.splice(idx, 1);
          saveTasks();
          renderTasks();
        });

        actions.appendChild(toggleBtn);
        actions.appendChild(deleteBtn);
        li.appendChild(span);
        li.appendChild(actions);
        taskList.appendChild(li);
      });
    }

    function addTask(text) {
      if (!text.trim()) return;
      tasks.push({ text: text.trim(), completed: false });
      taskInput.value = '';
      saveTasks();
      renderTasks();
    }

    /******************************************************************
     * 17. UPDATE WORD COUNT & READABILITY STATS
     ******************************************************************/
    function updateStats() {
      const text = codemirror.getValue();
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      statsDisplay.textContent = `Words: ${words} · Readability: —`;
      computeReadabilityMetrics(text);
    }

    function computeReadabilityMetrics(text) {
      if (!text.trim()) {
        statsDisplay.textContent = `Words: 0 · Readability: —`;
        return;
      }
      const sentences = text.split(/[\.\!?]+/).filter(s => s.trim().length > 0).length || 1;
      const wordsArr = text.split(/\s+/).filter(w => w.trim().length > 0).length || 1;
      let totalSyllables = 0;
      text.split(/\s+/).filter(w => w.trim().length > 0).forEach(w => {
        totalSyllables += countSyllables(w.replace(/[^A-Za-z]/g, ""));
      });
      const fk = 0.39 * (wordsArr / sentences) + 11.8 * (totalSyllables / wordsArr) - 15.59;
      statsDisplay.textContent = `Words: ${wordsArr} · Readability: ${fk.toFixed(1)}`;
    }
  </script>
</body>
</html>
